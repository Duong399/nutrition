<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T√≠nh Dinh D∆∞·ª°ng</title>
  <style>
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #2E7D32;
      --light-color: #E8F5E9;
      --text-color: #333;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      color: var(--text-color);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }
    
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 15px 0;
      text-align: center;
      box-shadow: var(--shadow);
    }
    
    h1, h2, h3 {
      margin: 0;
    }
    
    .main {
      display: flex;
      flex-wrap: wrap;
      margin-top: 20px;
      gap: 20px;
    }
    
    .food-input {
      flex: 1;
      min-width: 300px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }
    
    .nutrition-analysis {
      flex: 2;
      min-width: 400px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: var(--secondary-color);
    }
    
    .food-list {
      margin-top: 20px;
    }
    
    .food-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .remove-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: var(--light-color);
    }
    
    .total-row {
      font-weight: bold;
      background-color: var(--light-color);
    }
    
    .chatbox {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 350px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
      overflow: hidden;
    }
    
    .chat-header {
      background: var(--primary-color);
      color: white;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-body {
      height: 300px;
      overflow-y: auto;
      padding: 15px;
    }
    
    .chat-input {
      display: flex;
      border-top: 1px solid #eee;
      padding: 10px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }
    
    .message {
      margin-bottom: 10px;
      max-width: 80%;
    }
    
    .user-message {
      margin-left: auto;
      background: var(--light-color);
      padding: 10px;
      border-radius: 8px 8px 0 8px;
    }
    
    .ai-message {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 8px 8px 8px 0;
    }
    
    .hidden {
      display: none;
    }
    
    #chat-toggle {
      cursor: pointer;
    }
    
    #analyze-btn {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
    }
    
    @media (max-width: 768px) {
      .chatbox {
        width: 90%;
        right: 5%;
      }
    }
    .food-input-row {
      display: flex;
      gap: 10px;
    }

    .food-input-row input[type="text"] {
      flex: 3;
    }

    .food-input-row input[type="number"] {
      flex: 1;
      min-width: 100px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>T√≠nh Dinh D∆∞·ª°ng</h1>
    </div>
  </header>
  
  <div class="container">
    <div class="main">
      <div class="food-input">
        <h2>Nh·∫≠p Th·ª±c Ph·∫©m</h2>
        <div class="input-group food-input-row">
          <input type="text" id="food-name" placeholder="Nh·∫≠p t√™n th·ª±c ph·∫©m (v√≠ d·ª•: c∆°m tr·∫Øng)">
          <input type="number" id="food-quantity" placeholder="Kh·ªëi l∆∞·ª£ng (g)" value="100" min="1">
        </div>
        <button id="add-food-btn">Th√™m Th·ª±c Ph·∫©m</button>
        
        <div class="food-list" id="food-list">
          <!-- Danh s√°ch th·ª±c ph·∫©m s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
        </div>
        
        <button id="analyze-btn">Ph√¢n T√≠ch Dinh D∆∞·ª°ng</button>
      </div>
      
      <div class="nutrition-analysis">
        <h2>Ph√¢n T√≠ch Dinh D∆∞·ª°ng</h2>
        <div id="loading" class="loading hidden">ƒêang ph√¢n t√≠ch...</div>
        <div id="results">
          <table id="nutrition-table">
            <thead>
              <tr>
                <th>Th·ª±c Ph·∫©m</th>
                <th>Calo (kcal)</th>
                <th>Protein (g)</th>
                <th>Ch·∫•t B√©o (g)</th>
                <th>Carb (g)</th>
              </tr>
            </thead>
            <tbody>
              <!-- K·∫øt qu·∫£ ph√¢n t√≠ch s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td>T·ªïng</td>
                <td id="total-calories">0</td>
                <td id="total-protein">0</td>
                <td id="total-fat">0</td>
                <td id="total-carbs">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="chatbox" id="chatbox">
    <div class="chat-header">
      <h3>H·ªèi V·ªÅ Dinh D∆∞·ª°ng</h3>
      <span id="chat-toggle">‚àí</span>
    </div>
    <div class="chat-body" id="chat-body">
      <div class="message ai-message">
        Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ dinh d∆∞·ª°ng. H√£y h·ªèi t√¥i v·ªÅ th·ª±c ph·∫©m ho·∫∑c l·ªùi khuy√™n ƒÉn u·ªëng!
      </div>
    </div>
    <div class="chat-input">
      <input type="text" id="chat-input" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n...">
      <button id="send-btn">G·ª≠i</button>
    </div>
  </div>

  <script>
    // D·ªØ li·ªáu m·∫´u cho vi·ªác ph√¢n t√≠ch (thay th·∫ø b·∫±ng API th·ª±c t·∫ø trong tri·ªÉn khai th·ª±c)
    const foodDatabase = {
        "C∆°m tr·∫Øng": { calories: 130, protein: 2.7, fat: 0.3, carbs: 28.2 },
        
        // üêî Th·ªãt g√†
        "·ª®c g√† kh√¥ng da": { calories: 165, protein: 31, fat: 3.6, carbs: 0 },
        "ƒê√πi g√† kh√¥ng da": { calories: 119, protein: 23, fat: 2.6, carbs: 0 },
        "C√°nh g√† kh√¥ng da": { calories: 203, protein: 30.5, fat: 8.1, carbs: 0 },
        "L∆∞·ªùn g√† c√≥ da": { calories: 197, protein: 30, fat: 7.5, carbs: 0 },
        "ƒê√πi g√† c√≥ da": { calories: 209, protein: 27, fat: 10.2, carbs: 0 },
        "C√°nh g√† c√≥ da": { calories: 290, protein: 27, fat: 19.5, carbs: 0 },
        "Gan g√†": { calories: 136, protein: 20, fat: 4.8, carbs: 1.2 },
        
        // üêÑ Th·ªãt b√≤
        "Th·ªãt b√≤ n·∫°c": { calories: 250, protein: 26, fat: 15, carbs: 0 },
        "Th·ªãt b√≤ thƒÉn": { calories: 220, protein: 27, fat: 12, carbs: 0 },
        "Th·ªãt b√≤ s∆∞·ªùn": { calories: 290, protein: 24, fat: 21, carbs: 0 },
        "Th·ªãt b√≤ b·∫Øp": { calories: 200, protein: 30, fat: 8, carbs: 0 },
        "Gan b√≤": { calories: 135, protein: 20, fat: 3.6, carbs: 4 },
        
        // üêñ Th·ªãt heo
        "Th·ªãt heo n·∫°c": { calories: 143, protein: 26, fat: 3.9, carbs: 0 },
        "Th·ªãt ba ch·ªâ": { calories: 520, protein: 15, fat: 50, carbs: 0 },
        "S∆∞·ªùn heo": { calories: 290, protein: 23, fat: 22, carbs: 0 },
        "Gan heo": { calories: 165, protein: 25, fat: 5, carbs: 2.5 },
        "Tim heo": { calories: 180, protein: 22, fat: 10, carbs: 0 },
        
        // üêü H·∫£i s·∫£n
        "C√° h·ªìi": { calories: 206, protein: 22, fat: 13, carbs: 0 },
        "C√° thu": { calories: 201, protein: 18, fat: 13.9, carbs: 0 },
        "C√° ng·ª´": { calories: 144, protein: 32, fat: 1, carbs: 0 },
        "C√° basa": { calories: 120, protein: 15, fat: 5, carbs: 0 },
        "T√¥m": { calories: 99, protein: 24, fat: 0.3, carbs: 0.2 },
        "M·ª±c": { calories: 92, protein: 15.6, fat: 1.4, carbs: 3.1 },
        "Cua": { calories: 97, protein: 19, fat: 1.5, carbs: 1 },
        
        // ü•ö Tr·ª©ng
        "Tr·ª©ng g√†": { calories: 155, protein: 13, fat: 11, carbs: 1.1 },
        "Tr·ª©ng v·ªãt": { calories: 185, protein: 13, fat: 14, carbs: 1 },
        
        // üåø Rau c·ªß
        "C√† chua": { calories: 18, protein: 0.9, fat: 0.2, carbs: 3.9 },
        "D∆∞a leo": { calories: 15, protein: 0.6, fat: 0.1, carbs: 3.6 },
        "Rau c·∫£i xanh": { calories: 26, protein: 2.6, fat: 0.3, carbs: 4.3 },
        "C√† r·ªët": { calories: 41, protein: 0.9, fat: 0.2, carbs: 9.6 },
        "Su h√†o": { calories: 27, protein: 1.7, fat: 0.1, carbs: 6.2 },
        
        // üçé Tr√°i c√¢y
        "T√°o": { calories: 52, protein: 0.3, fat: 0.2, carbs: 13.8 },
        "Chu·ªëi": { calories: 89, protein: 1.1, fat: 0.3, carbs: 22.8 },
        "Nho": { calories: 69, protein: 0.7, fat: 0.2, carbs: 18 },
        "D∆∞a h·∫•u": { calories: 30, protein: 0.6, fat: 0.2, carbs: 7.6 },
        "B∆°": { calories: 160, protein: 2, fat: 15, carbs: 9 },
        
        // ü•ú H·∫°t
        "H·∫°t h·∫°nh nh√¢n": { calories: 579, protein: 21, fat: 49, carbs: 22 },
        "H·∫°t √≥c ch√≥": { calories: 654, protein: 15, fat: 65, carbs: 14 },
        "H·∫°t m·∫Øc ca": { calories: 718, protein: 8, fat: 76, carbs: 14 },
        "H·∫°t ƒëi·ªÅu": { calories: 553, protein: 18, fat: 44, carbs: 30 },
        "H·∫°t d·∫ª c∆∞·ªùi": { calories: 562, protein: 20, fat: 45, carbs: 28 },
        "H·∫°t ph·ªâ": { calories: 628, protein: 15, fat: 61, carbs: 17 },
        "H·∫°t h·ªì ƒë√†o": { calories: 691, protein: 9, fat: 72, carbs: 14 },
        "H·∫°t th√¥ng": { calories: 673, protein: 14, fat: 68, carbs: 13 }
    };


    // Kh·ªüi t·∫°o bi·∫øn to√†n c·ª•c
    let foodItems = [];
    let nutritionResults = [];
    
    // DOM Elements
    // DOM Elements
    const foodNameInput = document.getElementById('food-name');
    const foodQuantityInput = document.getElementById('food-quantity');
    const addFoodBtn = document.getElementById('add-food-btn');
    const foodList = document.getElementById('food-list');
    const analyzeBtn = document.getElementById('analyze-btn');
    const nutritionTable = document.getElementById('nutrition-table');
    const loadingDiv = document.getElementById('loading');
    const totalCalories = document.getElementById('total-calories');
    const totalProtein = document.getElementById('total-protein');
    const totalFat = document.getElementById('total-fat');
    const totalCarbs = document.getElementById('total-carbs');
    const chatToggle = document.getElementById('chat-toggle');
    const chatbox = document.getElementById('chatbox');
    const chatBody = document.getElementById('chat-body');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    
    // Event Listeners
    addFoodBtn.addEventListener('click', addFood);
    analyzeBtn.addEventListener('click', analyzeNutrition);
    chatToggle.addEventListener('click', toggleChat);
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // Th√™m th·ª±c ph·∫©m v√†o danh s√°ch
    function addFood() {
      const foodName = foodNameInput.value.trim();
      const foodQuantity = parseInt(document.getElementById('food-quantity').value) || 100;
      
      if (foodName === '') {
        alert('Vui l√≤ng nh·∫≠p t√™n th·ª±c ph·∫©m!');
        return;
      }
      
      const foodItem = { 
        id: Date.now(), 
        name: foodName,
        quantity: foodQuantity 
      };
      foodItems.push(foodItem);
      
      renderFoodList();
      foodNameInput.value = '';
      document.getElementById('food-quantity').value = '100';
      foodNameInput.focus();
    }
    
    // Hi·ªÉn th·ªã danh s√°ch th·ª±c ph·∫©m
    function renderFoodList() {
      foodList.innerHTML = '';
      
      foodItems.forEach(item => {
        const foodItemElement = document.createElement('div');
        foodItemElement.className = 'food-item';
        foodItemElement.innerHTML = `
          <span>${item.name} (${item.quantity}g)</span>
          <button class="remove-btn" data-id="${item.id}">X√≥a</button>
        `;
        foodList.appendChild(foodItemElement);
      });
      
      // Th√™m event listener cho c√°c n√∫t x√≥a
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = parseInt(this.getAttribute('data-id'));
          removeFood(id);
        });
      });
    }
    
    // X√≥a th·ª±c ph·∫©m kh·ªèi danh s√°ch
    function removeFood(id) {
      foodItems = foodItems.filter(item => item.id !== id);
      renderFoodList();
    }
    
    // Ph√¢n t√≠ch dinh d∆∞·ª°ng
    function analyzeNutrition() {
      if (foodItems.length === 0) {
        alert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt th·ª±c ph·∫©m!');
        return;
      }
      
      loadingDiv.classList.remove('hidden');
      
      // M√¥ ph·ªèng th·ªùi gian g·ªçi API
      setTimeout(() => {
        nutritionResults = [];
        
        // Ph√¢n t√≠ch t·ª´ng th·ª±c ph·∫©m
        foodItems.forEach(item => {
          const foodName = item.name.toLowerCase();
          const quantity = item.quantity / 100; // Chuy·ªÉn ƒë·ªïi sang h·ªá s·ªë so v·ªõi 100g
          let nutritionInfo = { 
            name: item.name + ` (${item.quantity}g)`, 
            calories: 0, 
            protein: 0, 
            fat: 0, 
            carbs: 0 
          };
          
          // T√¨m th√¥ng tin dinh d∆∞·ª°ng t·ª´ "database" m·∫´u
          for (const key in foodDatabase) {
            if (key.toLowerCase().includes(foodName)) {
              nutritionInfo.calories = Math.round(foodDatabase[key].calories * quantity * 10) / 10;
              nutritionInfo.protein = Math.round(foodDatabase[key].protein * quantity * 10) / 10;
              nutritionInfo.fat = Math.round(foodDatabase[key].fat * quantity * 10) / 10;
              nutritionInfo.carbs = Math.round(foodDatabase[key].carbs * quantity * 10) / 10;
              break;
            }
          }
          
          nutritionResults.push(nutritionInfo);
        });
        
        renderNutritionTable();
        loadingDiv.classList.add('hidden');
      }, 1500);
    }
    
    // Hi·ªÉn th·ªã b·∫£ng dinh d∆∞·ª°ng
    function renderNutritionTable() {
      const tbody = nutritionTable.querySelector('tbody');
      tbody.innerHTML = '';
      
      let totalCal = 0, totalProt = 0, totalFat = 0, totalCarb = 0;
      
      nutritionResults.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.calories}</td>
          <td>${item.protein}</td>
          <td>${item.fat}</td>
          <td>${item.carbs}</td>
        `;
        tbody.appendChild(row);
        
        // C·ªông d·ªìn t·ªïng
        totalCal += item.calories;
        totalProt += item.protein;
        totalFat += item.fat;
        totalCarb += item.carbs;
      });
      
      // C·∫≠p nh·∫≠t d√≤ng t·ªïng
      totalCalories.textContent = totalCal.toFixed(1);
      totalProtein.textContent = totalProt.toFixed(1);
      totalFat.textContent = totalFat.toFixed(1);
      totalCarbs.textContent = totalCarb.toFixed(1);
      loadingDiv.classList.remove('hidden');
      
      // M√¥ ph·ªèng th·ªùi gian g·ªçi API
      setTimeout(() => {
        nutritionResults = [];
        
        // Ph√¢n t√≠ch t·ª´ng th·ª±c ph·∫©m
        foodItems.forEach(item => {
          const foodName = item.name.toLowerCase();
          let nutritionInfo = { name: item.name, calories: 0, protein: 0, fat: 0, carbs: 0 };
          
          // T√¨m th√¥ng tin dinh d∆∞·ª°ng t·ª´ "database" m·∫´u
          for (const key in foodDatabase) {
            if (key.toLowerCase().includes(foodName)) {
              nutritionInfo.calories = foodDatabase[key].calories;
              nutritionInfo.protein = foodDatabase[key].protein;
              nutritionInfo.fat = foodDatabase[key].fat;
              nutritionInfo.carbs = foodDatabase[key].carbs;
              break;
            }
          }
          
          nutritionResults.push(nutritionInfo);
        });
        
        renderNutritionTable();
        loadingDiv.classList.add('hidden');
      }, 1500);
    }
    
    // Hi·ªÉn th·ªã b·∫£ng dinh d∆∞·ª°ng
    function renderNutritionTable() {
      const tbody = nutritionTable.querySelector('tbody');
      tbody.innerHTML = '';
      
      let totalCal = 0, totalProt = 0, totalFat = 0, totalCarb = 0;
      
      nutritionResults.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.calories}</td>
          <td>${item.protein}</td>
          <td>${item.fat}</td>
          <td>${item.carbs}</td>
        `;
        tbody.appendChild(row);
        
        // C·ªông d·ªìn t·ªïng
        totalCal += item.calories;
        totalProt += item.protein;
        totalFat += item.fat;
        totalCarb += item.carbs;
      });
      
      // C·∫≠p nh·∫≠t d√≤ng t·ªïng
      totalCalories.textContent = totalCal.toFixed(1);
      totalProtein.textContent = totalProt.toFixed(1);
      totalFat.textContent = totalFat.toFixed(1);
      totalCarbs.textContent = totalCarb.toFixed(1);
    }
    
    // B·∫≠t/t·∫Øt chatbox
    function toggleChat() {
      const chatBodyAndInput = document.querySelectorAll('.chat-body, .chat-input');
      
      chatBodyAndInput.forEach(el => {
        el.classList.toggle('hidden');
      });
      
      if (chatToggle.textContent === '‚àí') {
        chatToggle.textContent = '+';
      } else {
        chatToggle.textContent = '‚àí';
      }
    }
    // Th√™m bi·∫øn ƒë·ªÉ l∆∞u API key Cohere
    let cohereApiKey = "9MHD0XvvmkJQGfQpogAmNw6ozsZalaZa57OVFMPE"; // B·∫°n s·∫Ω nh·∫≠p API key c·ªßa m√¨nh v√†o ƒë√¢y

    // Thay th·∫ø h√†m sendMessage hi·ªán t·∫°i
    function sendMessage() {
      const message = chatInput.value.trim();
      
      if (message === '') {
        return;
      }
      
      // Th√™m tin nh·∫Øn ng∆∞·ªùi d√πng v√†o chat
      appendMessage(message, 'user');
      
      // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang g√µ
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message ai-message typing';
      typingDiv.textContent = 'ƒêang tr·∫£ l·ªùi...';
      chatBody.appendChild(typingDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
      
      // G·ªçi API Cohere
      callCohereAPI(message).then(response => {
        // X√≥a tr·∫°ng th√°i ƒëang g√µ
        chatBody.removeChild(typingDiv);
        
        // Th√™m c√¢u tr·∫£ l·ªùi v√†o chat
        appendMessage(response, 'ai');
      }).catch(error => {
        // X√≥a tr·∫°ng th√°i ƒëang g√µ
        chatBody.removeChild(typingDiv);
        
        // Th√™m th√¥ng b√°o l·ªói
        appendMessage("Xin l·ªói, t√¥i kh√¥ng th·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi n√†y. Vui l√≤ng th·ª≠ l·∫°i sau.", 'ai');
        console.error("Cohere API Error:", error);
      });
      
      chatInput.value = '';
    }

    // Th√™m h√†m g·ªçi API Cohere
    async function callCohereAPI(message) {
      if (!cohereApiKey) {
        // N·∫øu ch∆∞a nh·∫≠p API key, y√™u c·∫ßu ng∆∞·ªùi d√πng nh·∫≠p
        const apiKeyInput = prompt("Vui l√≤ng nh·∫≠p API key Cohere c·ªßa b·∫°n:");
        if (apiKeyInput && apiKeyInput.trim() !== '') {
          cohereApiKey = apiKeyInput.trim();
        } else {
          return "B·∫°n c·∫ßn nh·∫≠p API key Cohere ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng chat th√¥ng minh.";
        }
      }
      
      try {
        const response = await fetch('https://api.cohere.ai/v1/chat', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${cohereApiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: message,
            model: 'command-r-plus',
            preamble: "B·∫°n l√† tr·ª£ l√Ω dinh d∆∞·ª°ng AI gi√∫p t∆∞ v·∫•n v·ªÅ th·ª±c ph·∫©m, dinh d∆∞·ª°ng v√† ch·∫ø ƒë·ªô ƒÉn u·ªëng. H√£y tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, ng·∫Øn g·ªçn, th√¢n thi·ªán v√† cung c·∫•p th√¥ng tin khoa h·ªçc d·ª±a tr√™n nghi√™n c·ª©u. N·∫øu kh√¥ng bi·∫øt, h√£y th·ª´a nh·∫≠n v√† tr√°nh ƒë∆∞a ra th√¥ng tin sai.",
            temperature: 0.7,
            max_tokens: 300
          })
        });
        
        const data = await response.json();
        
        if (data.text) {
          return data.text;
        } else if (data.message) {
          return data.message;
        } else {
          console.error("Cohere API unexpected response:", data);
          return "Xin l·ªói, t√¥i kh√¥ng th·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi n√†y l√∫c n√†y.";
        }
      } catch (error) {
        console.error("Error calling Cohere API:", error);
        return "Xin l·ªói, c√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi API. Vui l√≤ng th·ª≠ l·∫°i sau.";
      }
    }

    // Th√™m CSS cho tr·∫°ng th√°i ƒëang g√µ
    const typingStyle = document.createElement('style');
    typingStyle.textContent = `
      .typing {
        color: #999;
        font-style: italic;
      }
      
      .setting-btn {
        background-color: transparent;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
      }
    `;
    document.head.appendChild(typingStyle);

    //### Th√™m n√∫t c√†i ƒë·∫∑t v√†o header c·ªßa chatbox
    //function addSettingsButton() {
    //  const chatHeader = document.querySelector('.chat-header');
    //  const settingsButton = document.createElement('button');
    //  settingsButton.className = 'setting-btn';
    //  settingsButton.textContent = '‚öôÔ∏è';
    //  settingsButton.title = 'C√†i ƒë·∫∑t API';
    
      
      // Th√™m n√∫t v√†o tr∆∞·ªõc n√∫t toggle
    //  chatHeader.insertBefore(settingsButton, document.getElementById('chat-toggle'));
      
      // Th√™m event listener cho n√∫t c√†i ƒë·∫∑t
    //  settingsButton.addEventListener('click', function() {
    //    const newApiKey = prompt("Nh·∫≠p API key Cohere c·ªßa b·∫°n:", cohereApiKey);
      //  if (newApiKey !== null) {
    //      cohereApiKey = newApiKey.trim();
    //      if (cohereApiKey) {
    //        appendMessage("API key ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.", 'ai');
    //      } else {
    //        appendMessage("API key kh√¥ng ƒë∆∞·ª£c nh·∫≠p. Chatbot s·∫Ω s·ª≠ d·ª•ng c√¢u tr·∫£ l·ªùi c∆° b·∫£n.", 'ai');
    //      }
    //    }
      //});
    //}

    // G·ªçi h√†m th√™m n√∫t c√†i ƒë·∫∑t khi trang t·∫£i xong
    //document.addEventListener('DOMContentLoaded', function() {
     // addSettingsButton();
      
      // Th√™m th√¥ng b√°o ch√†o m·ª´ng m·ªõi
    //  const welcomeMessage = document.querySelector('.message.ai-message');
    //  if (welcomeMessage) {
    //    welcomeMessage.textContent = 'Xin ch√†o! T√¥i l√† tr·ª£ l√Ω dinh d∆∞·ª°ng AI. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ dinh d∆∞·ª°ng, th·ª±c ph·∫©m v√† ch·∫ø ƒë·ªô ƒÉn u·ªëng. H√£y nh·∫•n v√†o bi·ªÉu t∆∞·ª£ng ‚öôÔ∏è ƒë·ªÉ nh·∫≠p API key Cohere tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu!';
    //  }
    //});

    // Thay ƒë·ªïi h√†m getAIResponse ƒë·ªÉ l√†m backup trong tr∆∞·ªùng h·ª£p kh√¥ng c√≥ API key
    function getAIResponse(message) {
      const lowerMsg = message.toLowerCase();
      
      if (lowerMsg.includes('calo') || lowerMsg.includes('calorie')) {
        return 'Calo l√† ƒë∆°n v·ªã ƒëo l∆∞·ªùng nƒÉng l∆∞·ª£ng t·ª´ th·ª±c ph·∫©m. M·ªôt ng∆∞·ªùi tr∆∞·ªüng th√†nh trung b√¨nh c·∫ßn kho·∫£ng 2000-2500 calo m·ªói ng√†y t√πy thu·ªôc v√†o m·ª©c ƒë·ªô ho·∫°t ƒë·ªông.';
      } else if (lowerMsg.includes('protein')) {
        return 'Protein r·∫•t quan tr·ªçng cho vi·ªác x√¢y d·ª±ng c∆° b·∫Øp. N√™n ti√™u th·ª• kho·∫£ng 0.8-1g protein/kg c√¢n n·∫∑ng m·ªói ng√†y. Ngu·ªìn protein t·ªët bao g·ªìm th·ªãt, c√°, tr·ª©ng, ƒë·∫≠u v√† c√°c lo·∫°i h·∫°t.';
      } else if (lowerMsg.includes('ch·∫•t b√©o') || lowerMsg.includes('fat')) {
        return 'Ch·∫•t b√©o l√†nh m·∫°nh r·∫•t c·∫ßn thi·∫øt cho c∆° th·ªÉ. N√™n ∆∞u ti√™n c√°c lo·∫°i ch·∫•t b√©o kh√¥ng b√£o h√≤a t·ª´ d·∫ßu √¥ liu, b∆°, c√° b√©o v√† c√°c lo·∫°i h·∫°t.';
      } else if (lowerMsg.includes('carb') || lowerMsg.includes('carbohydrate')) {
        return 'Carbohydrate l√† ngu·ªìn nƒÉng l∆∞·ª£ng ch√≠nh cho c∆° th·ªÉ. N√™n ch·ªçn carb ph·ª©c h·ª£p nh∆∞ ng≈© c·ªëc nguy√™n h·∫°t, khoai lang v√† c√°c lo·∫°i ƒë·∫≠u thay v√¨ ƒë∆∞·ªùng ƒë∆°n gi·∫£n.';
      } else if (lowerMsg.includes('gi·∫£m c√¢n') || lowerMsg.includes('diet')) {
        return 'ƒê·ªÉ gi·∫£m c√¢n hi·ªáu qu·∫£, n√™n k·∫øt h·ª£p ch·∫ø ƒë·ªô ƒÉn c√¢n b·∫±ng v·ªõi l∆∞·ª£ng calo th·∫•p h∆°n nhu c·∫ßu h·∫±ng ng√†y v√† t·∫≠p th·ªÉ d·ª•c ƒë·ªÅu ƒë·∫∑n. Kh√¥ng n√™n gi·∫£m qu√° 500-1000 calo/ng√†y so v·ªõi m·ª©c duy tr√¨.';
      } else if (lowerMsg.includes('tƒÉng c√¢n') || lowerMsg.includes('tƒÉng c∆°')) {
        return 'ƒê·ªÉ tƒÉng c√¢n kh·ªèe m·∫°nh, h√£y tƒÉng l∆∞·ª£ng calo ti√™u th·ª• v√† t·∫≠p luy·ªán s·ª©c m·∫°nh. T·∫≠p trung v√†o th·ª±c ph·∫©m gi√†u dinh d∆∞·ª°ng v√† tƒÉng protein ƒë·ªÉ ph√°t tri·ªÉn c∆° b·∫Øp.';
      } else {
        return 'Th·∫≠t ti·∫øc, t√¥i kh√¥ng c√≥ th√¥ng tin c·ª• th·ªÉ v·ªÅ c√¢u h·ªèi n√†y. B·∫°n c√≥ th·ªÉ h·ªèi v·ªÅ gi√° tr·ªã dinh d∆∞·ª°ng c·ªßa th·ª±c ph·∫©m ho·∫∑c l·ªùi khuy√™n v·ªÅ ch·∫ø ƒë·ªô ƒÉn u·ªëng kh√¥ng?';
      }
    }
    
    
    // Th√™m tin nh·∫Øn v√†o chatbox
    function appendMessage(content, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}-message`;
      messageDiv.textContent = content;
      
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    
    // M√¥ ph·ªèng ph·∫£n h·ªìi t·ª´ API Cohere
    // H√†m t√≠nh BMR (Basal Metabolic Rate)
    function calculateBMR(gender, weight, height, age) {
    if (gender === 'nam') {
        // C√¥ng th·ª©c BMR cho nam: 66.47 + (13.7 * c√¢n n·∫∑ng) + (5 * chi·ªÅu cao) - (6.8 * tu·ªïi)
        return 66.47 + (13.7 * weight) + (5 * height) - (6.8 * age);
    } else {
        // C√¥ng th·ª©c BMR cho n·ªØ: 655.1 + (9.6 * c√¢n n·∫∑ng) + (1.8 * chi·ªÅu cao) - (4.7 * tu·ªïi)
        return 655.1 + (9.6 * weight) + (1.8 * height) - (4.7 * age);
    }
    }

    // H√†m t√≠nh TDEE d·ª±a tr√™n m·ª©c ƒë·ªô ho·∫°t ƒë·ªông
    function calculateTDEE(bmr, activityLevel) {
    const activityMultipliers = {
        1: 1.2,   // Kh√¥ng t·∫≠p th·ªÉ thao
        2: 1.375, // 1-3 l·∫ßn/tu·∫ßn
        3: 1.55,  // 3-5 l·∫ßn/tu·∫ßn
        4: 1.725, // 6-7 l·∫ßn/tu·∫ßn
        5: 1.9    // V·∫≠n ƒë·ªông vi√™n/ lao ƒë·ªông r·∫•t n·∫∑ng
    };
    
    return bmr * activityMultipliers[activityLevel];
    }

    // H√†m t√≠nh calories c·∫ßn thi·∫øt cho m·ª•c ti√™u gi·∫£m c√¢n
    function calculateWeightLossCalories(tdee, kgPerMonth) {
    // 1kg m·ª° ~ 7700 calories
    // ƒê·ªÉ gi·∫£m 1kg/th√°ng, c·∫ßn gi·∫£m kho·∫£ng 7700/30 = ~257 calories/ng√†y
    return tdee - (kgPerMonth * 257);
    }

    // H√†m t√≠nh calories c·∫ßn thi·∫øt cho m·ª•c ti√™u tƒÉng c√¢n
    function calculateWeightGainCalories(tdee, kgPerMonth) {
    // ƒê·ªÉ tƒÉng 1kg/th√°ng, c·∫ßn tƒÉng kho·∫£ng 7700/30 = ~257 calories/ng√†y
    return tdee + (kgPerMonth * 257);
    }

    // Th√™m c√°c bi·∫øn v√† elements v√†o script hi·ªán t·∫°i
    document.addEventListener('DOMContentLoaded', function() {
    // Th√™m tr∆∞·ªùng nh·∫≠p li·ªáu v√†o food-input
    const foodInput = document.querySelector('.food-input');
    
    // T·∫°o ph·∫ßn t√≠nh BMR v√† TDEE
    const bmrCalculator = document.createElement('div');
    bmrCalculator.className = 'bmr-calculator';
    bmrCalculator.innerHTML = `
        <h3>T√≠nh BMR & TDEE</h3>
        <div class="input-group">
        <label>Gi·ªõi t√≠nh:</label>
        <select id="gender">
            <option value="nam">Nam</option>
            <option value="nu">N·ªØ</option>
        </select>
        </div>
        <div class="input-group">
        <label>C√¢n n·∫∑ng (kg):</label>
        <input type="number" id="weight" min="30" max="200" value="60">
        </div>
        <div class="input-group">
        <label>Chi·ªÅu cao (cm):</label>
        <input type="number" id="height" min="100" max="250" value="165">
        </div>
        <div class="input-group">
        <label>Tu·ªïi:</label>
        <input type="number" id="age" min="18" max="100" value="30">
        </div>
        <div class="input-group">
        <label>M·ª©c ƒë·ªô ho·∫°t ƒë·ªông:</label>
        <select id="activity-level">
            <option value="1">Kh√¥ng t·∫≠p th·ªÉ thao</option>
            <option value="2">1-3 l·∫ßn/tu·∫ßn</option>
            <option value="3">3-5 l·∫ßn/tu·∫ßn</option>
            <option value="4">6-7 l·∫ßn/tu·∫ßn</option>
            <option value="5">V·∫≠n ƒë·ªông vi√™n/ lao ƒë·ªông r·∫•t n·∫∑ng</option>
        </select>
        </div>
        <button id="calculate-bmr-btn">T√≠nh BMR & TDEE</button>
        
        <div id="bmr-results" class="results-section hidden">
        <h3>K·∫øt Qu·∫£ T√≠nh To√°n</h3>
        <div class="result-item">
            <span>BMR:</span>
            <span id="bmr-value">0</span>
            <span>calories/ng√†y</span>
        </div>
        <div class="result-item">
            <span>TDEE:</span>
            <span id="tdee-value">0</span>
            <span>calories/ng√†y</span>
        </div>
        
        <h3>M·ª•c Ti√™u Gi·∫£m C√¢n</h3>
        <div class="input-group">
            <label>S·ªë kg mu·ªën gi·∫£m m·ªói th√°ng:</label>
            <input type="number" id="weight-loss-kg" min="0" max="10" step="0.5" value="1">
        </div>
        <div class="result-item">
            <span>Calories m·ªói ng√†y:</span>
            <span id="weight-loss-calories">0</span>
            <span>calories/ng√†y</span>
        </div>
        
        <h3>M·ª•c Ti√™u TƒÉng C√¢n</h3>
        <div class="input-group">
            <label>S·ªë kg mu·ªën tƒÉng m·ªói th√°ng:</label>
            <input type="number" id="weight-gain-kg" min="0" max="10" step="0.5" value="1">
        </div>
        <div class="result-item">
            <span>Calories m·ªói ng√†y:</span>
            <span id="weight-gain-calories">0</span>
            <span>calories/ng√†y</span>
        </div>
        </div>
    `;
    
    // Th√™m v√†o tr∆∞·ªõc danh s√°ch th·ª±c ph·∫©m
    const foodList = document.getElementById('food-list');
    foodInput.appendChild(bmrCalculator);

    
    // Th√™m CSS cho ph·∫ßn m·ªõi
    const style = document.createElement('style');
    style.textContent = `
        .bmr-calculator {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        }
        
        .bmr-calculator h3 {
        margin-bottom: 15px;
        color: var(--primary-color);
        }
        
        .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        }
        
        .input-group select,
        .input-group input[type="number"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        margin-bottom: 15px;
        }
        
        .results-section {
        margin-top: 20px;
        padding: 15px;
        background-color: var(--light-color);
        border-radius: 8px;
        }
        
        .result-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 16px;
        }
        
        .result-item span:nth-child(2) {
        font-weight: bold;
        color: var(--primary-color);
        }
        
        .hidden {
        display: none;
        }
    `;
    document.head.appendChild(style);
    
    // Th√™m event listener cho n√∫t t√≠nh BMR
    document.getElementById('calculate-bmr-btn').addEventListener('click', function() {
        const gender = document.getElementById('gender').value;
        const weight = parseFloat(document.getElementById('weight').value);
        const height = parseFloat(document.getElementById('height').value);
        const age = parseInt(document.getElementById('age').value);
        const activityLevel = parseInt(document.getElementById('activity-level').value);
        
        // T√≠nh BMR v√† TDEE
        const bmr = calculateBMR(gender, weight, height, age);
        const tdee = calculateTDEE(bmr, activityLevel);
        
        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        document.getElementById('bmr-value').textContent = bmr.toFixed(0);
        document.getElementById('tdee-value').textContent = tdee.toFixed(0);
        
        // T√≠nh calories cho m·ª•c ti√™u gi·∫£m c√¢n
        const weightLossKg = parseFloat(document.getElementById('weight-loss-kg').value);
        const weightLossCalories = calculateWeightLossCalories(tdee, weightLossKg);
        document.getElementById('weight-loss-calories').textContent = weightLossCalories.toFixed(0);
        
        // T√≠nh calories cho m·ª•c ti√™u tƒÉng c√¢n
        const weightGainKg = parseFloat(document.getElementById('weight-gain-kg').value);
        const weightGainCalories = calculateWeightGainCalories(tdee, weightGainKg);
        document.getElementById('weight-gain-calories').textContent = weightGainCalories.toFixed(0);
        
        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        document.getElementById('bmr-results').classList.remove('hidden');
    });
    
    // Event listeners cho vi·ªác c·∫≠p nh·∫≠t calories khi thay ƒë·ªïi m·ª•c ti√™u
    document.getElementById('weight-loss-kg').addEventListener('input', function() {
        const tdee = parseFloat(document.getElementById('tdee-value').textContent);
        if (!isNaN(tdee)) {
        const weightLossKg = parseFloat(this.value);
        const weightLossCalories = calculateWeightLossCalories(tdee, weightLossKg);
        document.getElementById('weight-loss-calories').textContent = weightLossCalories.toFixed(0);
        }
    });
    
    document.getElementById('weight-gain-kg').addEventListener('input', function() {
        const tdee = parseFloat(document.getElementById('tdee-value').textContent);
        if (!isNaN(tdee)) {
        const weightGainKg = parseFloat(this.value);
        const weightGainCalories = calculateWeightGainCalories(tdee, weightGainKg);
        document.getElementById('weight-gain-calories').textContent = weightGainCalories.toFixed(0);
        }
    });
    
    // Th√™m th√¥ng tin ph√¢n t√≠ch v√†o b·∫£ng k·∫øt qu·∫£
    const analyzeBtn = document.getElementById('analyze-btn');
    const originalAnalyze = analyzeBtn.onclick || function(){};
    
    analyzeBtn.onclick = function() {
        // G·ªçi h√†m ph√¢n t√≠ch ban ƒë·∫ßu
        originalAnalyze.call(this);
        
        // Sau khi ph√¢n t√≠ch, th√™m th√¥ng tin so s√°nh v·ªõi m·ª•c ti√™u
        setTimeout(() => {
        const totalCaloriesValue = parseFloat(document.getElementById('total-calories').textContent);
        const weightLossCalories = parseFloat(document.getElementById('weight-loss-calories').textContent);
        const weightGainCalories = parseFloat(document.getElementById('weight-gain-calories').textContent);
        
        if (!isNaN(totalCaloriesValue) && !isNaN(weightLossCalories) && !isNaN(weightGainCalories)) {
            const nutritionAnalysis = document.querySelector('.nutrition-analysis');
            
            // Ki·ªÉm tra xem ƒë√£ c√≥ ph·∫ßn ph√¢n t√≠ch m·ª•c ti√™u ch∆∞a
            if (!document.getElementById('goal-comparison')) {
            const goalComparison = document.createElement('div');
            goalComparison.id = 'goal-comparison';
            goalComparison.className = 'goal-comparison';
            goalComparison.innerHTML = `
                <h3>So S√°nh V·ªõi M·ª•c Ti√™u</h3>
                <div class="comparison-item">
                <span>M·ª•c ti√™u gi·∫£m c√¢n:</span>
                <span id="loss-comparison"></span>
                </div>
                <div class="comparison-item">
                <span>M·ª•c ti√™u tƒÉng c√¢n:</span>
                <span id="gain-comparison"></span>
                </div>
            `;
            nutritionAnalysis.appendChild(goalComparison);
            
            // Th√™m CSS cho ph·∫ßn m·ªõi
            const styleComparison = document.createElement('style');
            styleComparison.textContent = `
                .goal-comparison {
                margin-top: 30px;
                padding: 15px;
                background-color: var(--light-color);
                border-radius: 8px;
                }
                
                .goal-comparison h3 {
                margin-bottom: 15px;
                color: var(--primary-color);
                }
                
                .comparison-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                font-size: 16px;
                }
                
                .comparison-item span:nth-child(2) {
                font-weight: bold;
                }
                
                .goal-met {
                color: green;
                }
                
                .goal-not-met {
                color: red;
                }
            `;
            document.head.appendChild(styleComparison);
            }
            
            // C·∫≠p nh·∫≠t so s√°nh
            const lossComparison = document.getElementById('loss-comparison');
            const gainComparison = document.getElementById('gain-comparison');
            
            // So s√°nh v·ªõi m·ª•c ti√™u gi·∫£m c√¢n
            const lossCaloriesDiff = totalCaloriesValue - weightLossCalories;
            if (lossCaloriesDiff <= 0) {
            lossComparison.className = 'goal-met';
            lossComparison.textContent = `ƒê·∫°t (${Math.abs(lossCaloriesDiff).toFixed(0)} calories d∆∞·ªõi m·ª•c ti√™u)`;
            } else {
            lossComparison.className = 'goal-not-met';
            lossComparison.textContent = `Ch∆∞a ƒë·∫°t (${lossCaloriesDiff.toFixed(0)} calories v∆∞·ª£t m·ª•c ti√™u)`;
            }
            
            // So s√°nh v·ªõi m·ª•c ti√™u tƒÉng c√¢n
            const gainCaloriesDiff = weightGainCalories - totalCaloriesValue;
            if (gainCaloriesDiff <= 0) {
            gainComparison.className = 'goal-met';
            gainComparison.textContent = `ƒê·∫°t (${Math.abs(gainCaloriesDiff).toFixed(0)} calories v∆∞·ª£t m·ª•c ti√™u)`;
            } else {
            gainComparison.className = 'goal-not-met';
            gainComparison.textContent = `Ch∆∞a ƒë·∫°t (${gainCaloriesDiff.toFixed(0)} calories d∆∞·ªõi m·ª•c ti√™u)`;
            }
        }
        }, 2000); // ƒê·ª£i ph√¢n t√≠ch ban ƒë·∫ßu ho√†n th√†nh
    };
    });

  </script>
</body>
